plugins {
  id "fabric-loom" version "${fabric_loom_version}"
  id "maven-publish"
}

base {
  archivesName = "${project.mod_id}@${project.minecraft_version}"
}

group = project.maven_group
version = project.version

sourceSets {
  javadoc {}

  testmod {
    compileClasspath += main.compileClasspath
    runtimeClasspath += main.runtimeClasspath
  }
}


loom {
  createRemapConfigurations(sourceSets.testmod)
}

repositories {
  mavenCentral()
  maven {
    name = 'ParchmentMC'
    url = 'https://maven.parchmentmc.org'
  }
}

dependencies {
  minecraft "com.mojang:minecraft:${minecraft_version}"
  modImplementation "net.fabricmc:fabric-loader:${project.fabric_loader_version}"
  modImplementation("net.fabricmc.fabric-api:fabric-api:${fabric_version}")

  mappings loom.officialMojangMappings()

  // Test mod dependencies
  testmodImplementation sourceSets.main.output
  modTestmodImplementation "net.fabricmc.fabric-api:fabric-api:${fabric_version}"
}

fabricApi {
  configureDataGeneration((settings) -> {
    settings.client = true
    settings.getOutputDirectory().set(project(":").file("src/testmod/generated"))
  })
}

processResources {
  def expandProps = [
    /* Minecraft */
    "minecraft_version"             : minecraft_version,
    "java_version"                  : java_version,

    /* Fabric */
    "fabric_version"                : fabric_version,
    "fabric_loader_version"         : fabric_loader_version,

    /* Mod */
    "mod_name"                      : mod_name,
    "mod_description"               : mod_description,
    "mod_id"                        : mod_id,
    "mod_version"                   : mod_version,
  ]

  filesMatching(['fabric.mod.json']) {
    expand expandProps
  }

  inputs.properties(expandProps)
}

runDatagen {
  outputs.dir file("src/testmod/generated")
  classpath += sourceSets.testmod.runtimeClasspath
}

java {
  withSourcesJar()
  withJavadocJar()

  sourceCompatibility = JavaVersion.VERSION_21
  targetCompatibility = JavaVersion.VERSION_21

  tasks.withType(JavaCompile) {
    options.encoding = "UTF-8"
    options.release = 21
  }
}

publishing {
  repositories {
    maven {
      name = "GitHubPackages"
      url = uri("https://maven.pkg.github.com/Seface-Studios/extended-fabric-datagen")
      credentials {
        username = System.getenv("GITHUB_ACTOR")
        password = System.getenv("GITHUB_TOKEN")
      }
    }
  }

  publications {
    gpr(MavenPublication) {
      from(components.java)
    }
  }
}
