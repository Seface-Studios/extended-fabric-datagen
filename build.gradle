plugins {
  id "fabric-loom" version "${fabric_loom_version}"
  id "maven-publish"
}

base {
  archivesName = "${project.mod_id}@${project.minecraft_version}"
}

group = project.maven_group
version = project.version

sourceSets {
  javadoc {}

  testmod {
    compileClasspath += main.compileClasspath
    runtimeClasspath += main.runtimeClasspath
  }
}


loom {
  createRemapConfigurations(sourceSets.testmod)
}

repositories {
  mavenCentral()
  maven {
    name = 'ParchmentMC'
    url = 'https://maven.parchmentmc.org'
  }
}

dependencies {
  minecraft "com.mojang:minecraft:${minecraft_version}"
  modImplementation "net.fabricmc:fabric-loader:${project.fabric_loader_version}"
  modImplementation("net.fabricmc.fabric-api:fabric-api:${fabric_version}")

  mappings loom.layered() {
    officialMojangMappings()
    parchment("org.parchmentmc.data:parchment-${project.parchmentmc_minecraft_version}:${project.parchmentmc_version}@zip")
  }

  // Test mod dependencies
  testmodImplementation sourceSets.main.output
  modTestmodImplementation "net.fabricmc.fabric-api:fabric-api:${fabric_version}"
}

fabricApi {
  configureDataGeneration((settings) -> {
    settings.client = true
    settings.getOutputDirectory().set(project(":").file("src/testmod/generated"))
  })
}

runDatagen {
  outputs.dir file("src/testmod/generated")
  classpath += sourceSets.testmod.runtimeClasspath
}

java {
  withSourcesJar()
  withJavadocJar()

  sourceCompatibility = JavaVersion.VERSION_21
  targetCompatibility = JavaVersion.VERSION_21

  tasks.withType(JavaCompile) {
    options.encoding = "UTF-8"
    options.release = 21
  }
}

publishing {
  repositories {
    maven {
      name = "GitHubPackages"
      url = uri("https://maven.pkg.github.com/Seface-Studios/extended-fabric-datagen")
      credentials {
        username = project.findProperty("gpr.user") ?: System.getenv("USERNAME")
        password = project.findProperty("gpr.key") ?: System.getenv("TOKEN")
      }
    }
  }

  publications {
    gpr(MavenPublication) {
      from(components.java)
    }
  }
}
